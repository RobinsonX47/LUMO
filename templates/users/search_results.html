{% extends "base.html" %} {% block title %}Search Users ‚Äì LUMO{% endblock %} {%
block content %}

<input
  type="hidden"
  id="csrf_token"
  name="csrf_token"
  value="{{ csrf_token() }}"
/>

<div style="max-width: 1000px; margin: 40px auto; padding: 0 20px">
  <!-- Search Form -->
  <div class="card-glass" style="padding: 32px; margin-bottom: 48px">
    <h1 style="margin-bottom: 24px">üîç Find Users</h1>

    <form
      method="GET"
      action="{{ url_for('users.search_users') }}"
      style="display: flex; gap: 12px; margin-bottom: 24px"
    >
      <input
        type="text"
        name="q"
        placeholder="Search by name or username..."
        value="{{ query }}"
        style="
          flex: 1;
          padding: 14px 18px;
          border-radius: 12px;
          border: 1px solid var(--glass-border);
          background: rgba(255, 255, 255, 0.05);
          color: var(--text);
          font-size: 1rem;
        "
      />
      <button
        type="submit"
        class="btn-primary"
        style="padding: 14px 32px; white-space: nowrap"
      >
        Search
      </button>
    </form>

    {% if query %}
    <p style="color: var(--muted); font-size: 14px">
      {% if results and results.total > 0 %} Found {{ results.total }} {{ 'user'
      if results.total == 1 else 'users' }} {% else %} No users found matching
      "{{ query }}" {% endif %}
    </p>
    {% else %}
    <p style="color: var(--muted); font-size: 14px">
      Start typing to search for users by name or username.
    </p>
    {% endif %}
  </div>

  <!-- Results -->
  {% if results and results.items %}
  <div
    style="
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 24px;
    "
  >
    {% for user in results.items %}
    <div
      class="card-glass user-card"
      style="
        padding: 28px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 14px;
        transition: transform 0.3s ease;
      "
    >
      <!-- Avatar -->
      <a
        href="{{ url_for('users.public_profile', username=user.username) }}"
        style="text-decoration: none"
      >
        <div
          style="
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
          "
        >
          {% if user.avatar %}
          <img
            src="{{ user.avatar }}"
            alt="{{ user.name }}"
            style="width: 100%; height: 100%; object-fit: cover"
          />
          {% else %}
          <div
            style="
              width: 100%;
              height: 100%;
              display: flex;
              align-items: center;
              justify-content: center;
              background: var(--gradient);
              font-size: 24px;
              font-weight: 700;
            "
          >
            {{ user.name[0]|upper }}
          </div>
          {% endif %}
        </div>
      </a>

      <!-- Name -->
      <a
        href="{{ url_for('users.public_profile', username=user.username) }}"
        style="text-decoration: none; color: inherit"
      >
        <h3 style="margin: 0">{{ user.name }}</h3>
        <p style="color: var(--muted); font-size: 14px">@{{ user.username }}</p>
      </a>

      <!-- Bio -->
      {% if user.bio %}
      <p style="color: var(--muted); font-size: 13px; line-height: 1.4">
        {{ user.bio[:100] }}{% if user.bio|length > 100 %}...{% endif %}
      </p>
      {% endif %}

      <!-- Follow Button -->
      {% if current_user.is_authenticated and current_user.id != user.id %} {%
      if user.id in following_ids %}
      <button
        class="btn-secondary"
        onclick="unfollowUser(this, {{ user.id }})"
        style="width: 100%; padding: 12px 14px; border-radius: 12px"
      >
        ‚úì Following
      </button>
      {% else %}
      <button
        class="btn-primary"
        onclick="followUser(this, {{ user.id }})"
        style="width: 100%; padding: 12px 14px; border-radius: 12px"
      >
        + Follow
      </button>
      {% endif %} {% elif not current_user.is_authenticated %}
      <a
        href="{{ url_for('auth.login', next=request.url) }}"
        class="btn-primary"
        style="
          width: 100%;
          padding: 12px 14px;
          border-radius: 12px;
          text-align: center;
          text-decoration: none;
          display: block;
        "
      >
        + Follow
      </a>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if results.pages > 1 %}
  <div
    style="display: flex; justify-content: center; gap: 12px; margin-top: 48px"
  >
    {% if results.has_prev %}
    <a
      href="{{ url_for('users.search_users', q=query, page=results.prev_num) }}"
      class="btn-tertiary"
      >‚Üê Previous</a
    >
    {% endif %} {% for page_num in results.iter_pages() %} {% if page_num %} {%
    if page_num == results.page %}
    <span class="btn-tertiary" style="background: var(--primary); color: white"
      >{{ page_num }}</span
    >
    {% else %}
    <a
      href="{{ url_for('users.search_users', q=query, page=page_num) }}"
      class="btn-tertiary"
      >{{ page_num }}</a
    >
    {% endif %} {% endif %} {% endfor %} {% if results.has_next %}
    <a
      href="{{ url_for('users.search_users', q=query, page=results.next_num) }}"
      class="btn-tertiary"
      >Next ‚Üí</a
    >
    {% endif %}
  </div>
  {% endif %} {% endif %}
</div>

<style>
  .btn-tertiary {
    display: inline-block;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    color: var(--text);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .btn-tertiary:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 255, 255, 0.25);
  }

  .card-glass:hover {
    transform: translateY(-4px);
  }
</style>

<script>
  function followUser(btn, userId) {
    const url = `/users/${userId}/follow`;
    fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.getElementById("csrf_token").value,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          btn.textContent = "‚úì Following";
          btn.className = "btn-secondary";
          btn.onclick = function () {
            unfollowUser(btn, userId);
          };
        }
      });
  }

  function unfollowUser(btn, userId) {
    const url = `/users/${userId}/unfollow`;
    fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.getElementById("csrf_token").value,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          btn.textContent = "+ Follow";
          btn.className = "btn-primary";
          btn.onclick = function () {
            followUser(btn, userId);
          };
        }
      });
  }
</script>

{% endblock %}
