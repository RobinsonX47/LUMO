{% extends "base.html" %}
{% block title %}{{ movie.title }} ‚Äì CineSphere{% endblock %}
{% block content %}

<!-- Movie Hero Section -->
<div style="margin: -90px -4vw 48px; padding-top: 90px; position: relative; overflow: hidden;">
  <div style="position: relative; min-height: 400px;">
    <div style="position: absolute; inset: 0; background: linear-gradient(to top, #050816 0%, rgba(5,8,22,0.7) 50%, rgba(5,8,22,0.3) 100%);">
      {% if movie.backdrop_url %}
      <img src="{{ movie.backdrop_url }}" alt="{{ movie.title }}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.3;" />
      {% endif %}
    </div>
    
    <div style="position: relative; z-index: 10; max-width: 1400px; margin: 0 auto; padding: 60px 4vw 40px;">
      <div style="display: grid; grid-template-columns: 300px 1fr; gap: 40px;">
        <div>
          {% if movie.poster_url %}
          <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" style="width: 100%; border-radius: 24px; box-shadow: 0 30px 80px rgba(0,0,0,0.9);" />
          {% else %}
          <div style="width: 100%; aspect-ratio: 2/3; background: linear-gradient(135deg, #4f46e5, #ec4899); border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 5rem;">
            üé¨
          </div>
          {% endif %}
        </div>

        <div>
          <h1 style="margin-bottom: 12px; font-size: 3rem;">{{ movie.title }}</h1>
          
          {% if movie.tagline %}
          <p style="font-style: italic; color: var(--muted); margin-bottom: 16px; font-size: 1.1rem;">
            "{{ movie.tagline }}"
          </p>
          {% endif %}
          
          <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            {% if movie.release_date %}
            <span class="badge-pill">üìÖ {{ movie.release_date }}</span>
            {% endif %}
            {% if movie.runtime %}
            <span class="badge-pill">‚è±Ô∏è {{ movie.runtime }} min</span>
            {% endif %}
            <span class="badge-pill">‚≠ê {{ movie.vote_average|round(1) }}/10 TMDB</span>
            {% if movie.local_avg_rating %}
            <span class="badge-pill" style="background: rgba(123, 92, 255, 0.2); border-color: var(--accent);">
              ‚≠ê {{ movie.local_avg_rating }}/5 ({{ movie.local_review_count }} reviews)
            </span>
            {% endif %}
          </div>

          <!-- Genres -->
          {% if movie.genres %}
          <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
            {% for genre in movie.genres %}
            <a href="{{ url_for('main.movies_by_genre', genre_id=genre.id) }}" 
               style="padding: 6px 14px; border-radius: 999px; background: rgba(123, 92, 255, 0.15); color: var(--accent); text-decoration: none; font-size: 0.85rem; border: 1px solid rgba(123, 92, 255, 0.3);">
              {{ genre.name }}
            </a>
            {% endfor %}
          </div>
          {% endif %}

          {% if movie.overview %}
          <p style="color: var(--muted); line-height: 1.8; margin-bottom: 24px; font-size: 1.05rem;">
            {{ movie.overview }}
          </p>
          {% endif %}

          <div style="display: flex; gap: 16px; flex-wrap: wrap;">
            {% if movie.trailer_url %}
            <a href="{{ movie.trailer_url }}" target="_blank" 
               class="btn-primary" 
               style="display: inline-flex; align-items: center; gap: 8px; padding: 14px 28px; border-radius: 12px; background: linear-gradient(135deg, #7b5cff, #a78bfa); color: white; text-decoration: none; font-weight: 600;">
              ‚ñ∂Ô∏è Watch Trailer
            </a>
            {% endif %}
            
            {% if current_user.is_authenticated %}
            <form method="POST" action="{{ url_for('movies.toggle_watchlist', movie_id=movie.id) }}" style="display: inline;">
              <button type="submit" 
                      class="btn-secondary"
                      style="padding: 14px 28px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.7); color: var(--text); cursor: pointer; font-size: 1rem; font-weight: 600; backdrop-filter: blur(10px);">
                {% if in_watchlist %}
                  ‚úì In Watchlist
                {% else %}
                  + Add to Watchlist
                {% endif %}
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cast Section -->
{% if movie.credits and movie.credits.cast %}
<section style="margin-bottom: 48px;">
  <h2 style="margin-bottom: 24px;">Cast</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px;">
    {% for actor in movie.credits.cast[:10] %}
    <div class="card-glass" style="padding: 12px; text-align: center;">
      {% if actor.profile_path %}
      <img src="https://image.tmdb.org/t/p/w185{{ actor.profile_path }}" 
           alt="{{ actor.name }}" 
           style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 12px; margin-bottom: 8px;" />
      {% else %}
      <div style="width: 100%; aspect-ratio: 2/3; background: linear-gradient(135deg, #4f46e5, #ec4899); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 8px;">
        üë§
      </div>
      {% endif %}
      <div style="font-size: 0.85rem; font-weight: 600;">{{ actor.name }}</div>
      <div style="font-size: 0.75rem; color: var(--muted);">{{ actor.character }}</div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- Reviews Section -->
<section style="margin-bottom: 48px;">
  <h2 style="margin-bottom: 24px;">User Reviews</h2>

  {% if current_user.is_authenticated %}
    <div class="card-glass" style="padding: 24px; margin-bottom: 32px;">
      <h3 style="margin-bottom: 16px;">
        {% if user_review %}Edit Your Review{% else %}Write a Review{% endif %}
      </h3>
      
      <form method="POST" action="{{ url_for('movies.add_review', movie_id=movie.id) }}">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--muted);">Your Rating</label>
          <div style="display: flex; gap: 8px;">
            {% for i in range(1, 6) %}
              <input type="radio" name="rating" value="{{ i }}" id="rating{{ i }}" 
                     {% if user_review and user_review.rating == i %}checked{% endif %}
                     required style="display: none;" />
              <label for="rating{{ i }}" class="star-rating" 
                     style="font-size: 2rem; cursor: pointer; transition: transform 0.2s;">‚≠ê</label>
            {% endfor %}
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--muted);">Your Review</label>
          <textarea 
            name="review_text" 
            rows="4" 
            required
            placeholder="Share your thoughts about this movie..."
            style="width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.3); background: rgba(15, 23, 42, 0.5); color: var(--text); font-size: 1rem; resize: vertical; font-family: inherit;"
          >{% if user_review %}{{ user_review.review_text }}{% endif %}</textarea>
        </div>

        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn-primary" 
                  style="padding: 12px 32px; border-radius: 12px; border: none; background: linear-gradient(135deg, #7b5cff, #a78bfa); color: white; font-weight: 600; cursor: pointer;">
            {% if user_review %}Update Review{% else %}Submit Review{% endif %}
          </button>
          
          {% if user_review %}
          <button type="button" onclick="if(confirm('Delete this review?')) document.getElementById('deleteForm').submit();" 
                  class="btn-secondary"
                  style="padding: 12px 24px; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.15); color: #fca5a5; cursor: pointer;">
            Delete Review
          </button>
          {% endif %}
        </div>
      </form>
      
      {% if user_review %}
      <form id="deleteForm" method="POST" action="{{ url_for('movies.delete_review', movie_id=movie.id) }}" style="display: none;"></form>
      {% endif %}
    </div>
  {% else %}
    <div class="card-glass" style="padding: 24px; margin-bottom: 32px; text-align: center;">
      <p style="color: var(--muted); margin-bottom: 16px;">Sign in to write a review</p>
      <a href="{{ url_for('auth.login') }}" 
         class="btn-primary"
         style="display: inline-block; padding: 12px 32px; border-radius: 12px; background: linear-gradient(135deg, #7b5cff, #a78bfa); color: white; text-decoration: none; font-weight: 600;">
        Sign In
      </a>
    </div>
  {% endif %}

  <!-- Existing Reviews -->
  <div style="display: flex; flex-direction: column; gap: 16px;">
    {% for review in reviews %}
      <div class="card-glass" style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div>
            <strong style="font-size: 1.1rem;">{{ review.user.name }}</strong>
            <div style="color: var(--muted); font-size: 0.85rem;">
              {{ review.created_at.strftime('%B %d, %Y') }}
              {% if review.updated_at != review.created_at %}
                (edited)
              {% endif %}
            </div>
          </div>
          <div style="display: flex; gap: 4px; color: #fbbf24; font-size: 1.2rem;">
            {% for i in range(review.rating) %}‚≠ê{% endfor %}
          </div>
        </div>
        <p style="color: var(--text); line-height: 1.6;">
          {{ review.review_text }}
        </p>
      </div>
    {% else %}
      <p style="text-align: center; color: var(--muted); padding: 40px;">
        No reviews yet. Be the first to review!
      </p>
    {% endfor %}
  </div>
</section>

<!-- Similar Movies -->
{% if movie.similar and movie.similar.results %}
<section style="margin-bottom: 48px;">
  <h2 style="margin-bottom: 24px;">Similar Movies</h2>
  <div class="movie-grid">
    {% for similar in movie.similar.results[:6] %}
    <a href="{{ url_for('movies.movie_detail', movie_id=similar.id) }}" style="text-decoration: none; color: inherit;">
      <div class="card-glass">
        {% if similar.poster_path %}
        <img src="https://image.tmdb.org/t/p/w500{{ similar.poster_path }}" 
             alt="{{ similar.title }}" 
             class="movie-poster" />
        {% else %}
        <div class="movie-poster" style="background: linear-gradient(135deg, #4f46e5, #ec4899); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
          üé¨
        </div>
        {% endif %}
        <div class="movie-title">{{ similar.title }}</div>
        <div class="movie-meta">‚≠ê {{ similar.vote_average|round(1) }}/10</div>
      </div>
    </a>
    {% endfor %}
  </div>
</section>
{% endif %}

<style>
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(123, 92, 255, 0.4);
  }

  .btn-secondary:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
  }

  .star-rating:hover {
    transform: scale(1.2);
  }

  input[type="radio"]:checked + .star-rating {
    filter: brightness(1.3);
  }

  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  @media (max-width: 768px) {
    .card-glass > div:first-child {
      grid-template-columns: 1fr !important;
    }
  }
</style>

{% endblock %}