{% extends "base.html" %} {% block title %}{{ movie.title }} ‚Äì LUMO{% endblock
%} {% block content %}

<!-- Fullscreen Premium Movie Hero with Auto-Playing Trailer -->
<div id="movieHero" class="premium-hero-fullscreen">
  <!-- YouTube Trailer Background (fullscreen, highest quality) -->
  {% if movie.trailer_key %}
  <div id="trailerContainer" class="trailer-container-fullscreen">
    <div id="posterOverlay" class="hero-poster-overlay">
      <img
        src="{{ movie.backdrop_url or movie.poster_url }}"
        alt="{{ movie.title }}"
      />
      <div class="hero-gradient-overlay"></div>
    </div>
    <div id="trailerPlayer"></div>
    <div class="trailer-fade-overlay"></div>

    <!-- Mute/Unmute Button -->
    <button id="muteBtn" class="mute-btn-premium">
      <svg
        id="muteIcon"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </svg>
    </button>

    <!-- Scroll indicator -->
    <div class="scroll-indicator">
      <span>Scroll for details</span>
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="7 13 12 18 17 13"></polyline>
        <polyline points="7 6 12 11 17 6"></polyline>
      </svg>
    </div>
  </div>
  {% else %}
  <!-- Fallback poster if no trailer -->
  <div class="hero-poster-fallback">
    <img src="{{ movie.backdrop_url }}" alt="{{ movie.title }}" />
    <div class="hero-gradient-overlay"></div>
  </div>
  {% endif %}

  <!-- Movie Info Overlay (Netflix-style - LEFT SIDE) -->
  <div id="heroOverlay" class="hero-info-overlay-netflix">
    <div class="hero-content-wrapper-netflix">
      <div id="heroDetails" class="hero-details-netflix">
        {% if movie.logo_url %}
        <img
          class="hero-logo-premium"
          src="{{ movie.logo_url }}"
          alt="{{ movie.title }} logo"
          loading="lazy"
          onerror="this.classList.add('is-hidden'); this.nextElementSibling.classList.remove('is-hidden');"
        />
        <h1 class="hero-title-premium is-hidden">{{ movie.title }}</h1>
        {% else %}
        <h1 class="hero-title-premium">{{ movie.title }}</h1>
        {% endif %}

        {% if movie.tagline %}
        <p class="hero-tagline-premium">"{{ movie.tagline }}"</p>
        {% endif %}

        <div class="hero-meta-row">
          {% if movie.release_date %}
          <span class="badge-pill">üìÖ {{ movie.release_date[:4] }}</span>
          {% endif %} {% if movie.runtime %}
          <span class="badge-pill">‚è±Ô∏è {{ movie.runtime }} min</span>
          {% endif %}
          <span class="badge-pill"
            >‚≠ê {{ movie.vote_average|round(1) }}/10</span
          >
          {% if movie.local_avg_rating %}
          <span class="badge-pill badge-highlight"
            >‚≠ê {{ movie.local_avg_rating }}/5 ({{ movie.local_review_count
            }})</span
          >
          {% endif %}
        </div>

        {% if movie.genres %}
        <div class="hero-genres-row">
          {% for genre in movie.genres %}
          <a
            href="{{ url_for('main.movies_by_genre', genre_id=genre.id) }}"
            class="genre-tag-premium"
            >{{ genre.name }}</a
          >
          {% endfor %}
        </div>
        {% endif %} {% if movie.overview %}
        <p class="hero-overview-premium">{{ movie.overview }}</p>
        {% endif %}

        <div class="hero-actions-row">
          {% if current_user.is_authenticated %}
          <button
            type="button"
            class="btn-primary btn-watchlist-premium"
            id="watchlistBtn"
            onclick="toggleWatchlist({{ movie.id }}, '{{ media_type }}')"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="{% if in_watchlist %}currentColor{% else %}none{% endif %}"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              id="watchlistIcon"
            >
              <path
                d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            <span id="watchlistText"
              >{% if in_watchlist %}In Watchlist{% else %}Add to Watchlist{%
              endif %}</span
            >
          </button>
          {% else %}
          <a href="{{ url_for('auth.login') }}" class="btn-primary">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            Sign in to Add
          </a>
          {% endif %}

          <button
            class="btn-secondary"
            onclick="
              document
                .getElementById('reviewSection')
                .scrollIntoView({ behavior: 'smooth' })
            "
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            Write Review
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Content Section (scrollable) -->
<div class="movie-detail-content">
  <!-- Cast Section -->
  {% if movie.credits and movie.credits.cast %}
  <section class="content-section">
    <h2>‚ú® Cast</h2>
    <div class="cast-grid-premium">
      {% for actor in movie.credits.cast[:10] %}
      <div class="cast-card-premium">
        {% if actor.profile_path %}
        <img
          src="https://image.tmdb.org/t/p/original{{ actor.profile_path }}"
          alt="{{ actor.name }}"
          class="cast-photo-premium"
        />
        {% else %}
        <div class="cast-photo-placeholder">üë§</div>
        {% endif %}
        <div class="cast-name-premium">{{ actor.name }}</div>
        <div class="cast-character-premium">{{ actor.character }}</div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Reviews Section -->
  <section class="content-section" id="reviewSection">
    <h2>üí¨ User Reviews</h2>

    {% if current_user.is_authenticated %}
    <div class="review-form-card-premium">
      <h3>
        {% if user_review %}Edit Your Review{% else %}Write a Review{% endif %}
      </h3>

      <form
        method="POST"
        action="{{ url_for('movies.add_review', movie_id=movie.id) }}"
        aria-label="Movie review form"
      >
        <div class="form-group">
          <label for="rating-group">Your Rating (1-5 stars)</label>
          <div class="star-rating-input-premium" id="rating-group" role="group" aria-labelledby="rating-label">
            <span id="rating-label" style="display: none;">Select a rating from 1 to 5 stars</span>
            {% set rating_value = user_review.rating if user_review else 0 %}
            <input type="radio" name="rating" value="5" id="rating5" aria-label="5 stars" {{'checked' if rating_value == 5 else ''}} required /><label for="rating5" class="star-label-premium" aria-hidden="true">‚≠ê</label>
            <input type="radio" name="rating" value="4" id="rating4" aria-label="4 stars" {{'checked' if rating_value == 4 else ''}} required /><label for="rating4" class="star-label-premium" aria-hidden="true">‚≠ê</label>
            <input type="radio" name="rating" value="3" id="rating3" aria-label="3 stars" {{'checked' if rating_value == 3 else ''}} required /><label for="rating3" class="star-label-premium" aria-hidden="true">‚≠ê</label>
            <input type="radio" name="rating" value="2" id="rating2" aria-label="2 stars" {{'checked' if rating_value == 2 else ''}} required /><label for="rating2" class="star-label-premium" aria-hidden="true">‚≠ê</label>
            <input type="radio" name="rating" value="1" id="rating1" aria-label="1 star" {{'checked' if rating_value == 1 else ''}} required /><label for="rating1" class="star-label-premium" aria-hidden="true">‚≠ê</label>
          </div>
        </div>

        <div class="form-group">
          <label for="review-text">Your Review</label>
          <textarea
            id="review-text"
            name="review_text"
            rows="4"
            required
            placeholder="Share your thoughts..."
            aria-describedby="review-help"
          >
{% if user_review %}{{ user_review.review_text }}{% endif %}</textarea>
          <small id="review-help" style="color: var(--text-muted); display: block; margin-top: 4px;">Share your honest thoughts about this movie (optional but appreciated)</small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" aria-label="Submit movie review">
            {% if user_review %}Update Review{% else %}Submit Review{% endif %}
          </button>

          {% if user_review %}
          <button
            type="button"
            onclick="
              if (confirm('Delete this review?'))
                document.getElementById('deleteForm').submit();
            "
            class="btn-danger-premium"
            aria-label="Delete your review"
          >
            Delete Review
          </button>
          {% endif %}
        </div>
      </form>

      {% if user_review %}
      <form
        id="deleteForm"
        method="POST"
        action="{{ url_for('movies.delete_review', movie_id=movie.id) }}"
        style="display: none"
      ></form>
      {% endif %}
    </div>
    {% else %}
    <div class="auth-prompt-card-premium">
      <p>Sign in to write a review</p>
      <a href="{{ url_for('auth.login') }}" class="btn-primary">Sign In</a>
    </div>
    {% endif %}

    <div class="reviews-list-premium">
      {% for review in reviews %}
      <div class="review-card-premium">
        <div class="review-header-premium">
          <div>
            <strong class="reviewer-name-premium"
              >{{ review.user.name }}</strong
            >
            <div class="review-date-premium">
              {{ review.created_at.strftime('%B %d, %Y') }} {% if
              review.updated_at != review.created_at %}<span class="edited-tag"
                >(edited)</span
              >{% endif %}
            </div>
          </div>
          <div class="review-stars-premium">
            {% for i in range(review.rating) %}‚≠ê{% endfor %}
          </div>
        </div>
        <p class="review-text-premium">{{ review.review_text }}</p>
      </div>
      {% else %}
      <p class="no-reviews-msg">No reviews yet. Be the first to review!</p>
      {% endfor %}
    </div>
  </section>

  <!-- AI-style Curated Similar -->
  {% if smart_recs %}
  <section class="content-section">
    <h2>üé¨ You Might Also Like</h2>
    <div class="movie-grid">
      {% for rec in smart_recs %}
      <a
        href="{{ url_for('movies.tv_detail', tv_id=rec.id) if rec.media_type == 'tv' else url_for('movies.movie_detail', movie_id=rec.id) }}"
        class="card-link"
      >
        <div class="card-glass">
          {% if rec.poster_path %}
          <img
            src="https://image.tmdb.org/t/p/w500{{ rec.poster_path }}"
            alt="{{ rec.title or rec.name }}"
            class="movie-poster"
          />
          {% else %}
          <div class="movie-poster movie-poster-placeholder">üé¨</div>
          {% endif %}
          <div class="movie-title">{{ rec.title or rec.name }}</div>
          <div class="movie-meta">
            {% if rec.release_date or rec.first_air_date %}
            {{ (rec.release_date or rec.first_air_date)[:4] }} ‚Ä¢
            {% endif %}
            ‚≠ê {{ rec.vote_average|round(1) }}/10
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}
</div>

{% if not current_user.is_authenticated %}
<section class="content-section" style="text-align:center; margin-top:24px">
  <h2>ü§ñ AI Recommendations</h2>
  <p style="color: var(--muted); margin-bottom: 12px;">
    Log in to get personalized picks based on your tastes.
  </p>
  <a href="{{ url_for('auth.login', next=request.url) }}" class="btn-primary nav-ai-btn" style="display:inline-flex; align-items:center; gap:8px;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
    </svg>
    Login to See Recommendations
  </a>
</section>
{% else %}
<section class="content-section" style="text-align:center; margin-top:24px">
  <a href="{{ url_for('movies.recommendations') }}" class="btn-primary nav-ai-btn" style="display:inline-flex; align-items:center; gap:8px;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
    </svg>
    See AI Recommendations
  </a>
</section>
{% endif %}

<style>
  /* Premium Fullscreen Hero */
  .premium-hero-fullscreen {
    position: relative;
    width: 100vw;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    margin-top: -100px;
    height: 100vh;
    max-height: 100vh;
    overflow: hidden;
    background: #000;
  }

  .trailer-container-fullscreen {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .hero-poster-overlay {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 4;
    opacity: 1;
    transition: opacity 0.8s ease;
  }

  .hero-poster-overlay.is-hidden {
    opacity: 0;
    pointer-events: none;
  }

  .hero-poster-overlay img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  #trailerPlayer {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100vw;
    height: 100vh;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  /* Ensure 16:9 aspect ratio fills screen */
  @media (min-aspect-ratio: 16/9) {
    #trailerPlayer {
      width: 100vw;
      height: 56.25vw;
    }
  }

  @media (max-aspect-ratio: 16/9) {
    #trailerPlayer {
      width: 177.78vh;
      height: 100vh;
    }
  }

  /* REDUCED BOTTOM FADE - Much more subtle */
  .trailer-fade-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 80%,
      rgba(0, 0, 0, 0.2) 92%,
      rgba(0, 0, 0, 0.6) 100%
    );
    pointer-events: none;
    z-index: 2;
  }

  .mute-btn-premium {
    position: fixed;
    bottom: 40px;
    right: 40px;
    z-index: 30;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    color: white;
  }

  .mute-btn-premium:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.1);
    box-shadow: 0 8px 24px rgba(10, 132, 255, 0.4);
  }

  .scroll-indicator {
    position: absolute;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    color: white;
    font-size: 0.9rem;
    animation: smoothFloat 3s ease-in-out infinite;
    opacity: 0.8;
  }

  /* REMOVED BOUNCE - Smooth float instead */
  @keyframes smoothFloat {
    0%,
    100% {
      transform: translateX(-50%) translateY(0);
    }
    50% {
      transform: translateX(-50%) translateY(-8px);
    }
  }

  /* NETFLIX-STYLE LEFT ALIGNMENT */
  .hero-info-overlay-netflix {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.9) 0%,
      rgba(0, 0, 0, 0.7) 50%,
      transparent 100%
    );
    padding: 60px 0 60px 80px;
    transform: translateY(0);
    transition: transform 0.5s ease;
  }

  .hero-content-wrapper-netflix {
    max-width: 800px;
  }

  .hero-details-netflix {
    width: 100%;
  }

  .hero-title-premium {
    font-size: 3.5rem;
    font-weight: 700;
    margin-bottom: 12px;
    line-height: 1.1;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
  }

  .hero-logo-premium {
    display: block;
    width: auto;
    max-width: min(480px, 85%);
    max-height: 150px;
    height: auto;
    object-fit: contain;
    object-position: left center;
    margin-bottom: 20px;
    filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.55));
  }

  .hero-logo-premium.is-hidden,
  .hero-title-premium.is-hidden {
    display: none !important;
  }

  .hero-tagline-premium {
    font-style: italic;
    color: var(--text-secondary);
    font-size: 1.3rem;
    margin-bottom: 24px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
  }

  .hero-meta-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .badge-highlight {
    background: rgba(10, 132, 255, 0.25);
    border-color: var(--accent);
    color: var(--accent);
  }

  .hero-genres-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }

  .genre-tag-premium {
    padding: 8px 16px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    border: 1px solid var(--glass-border);
    transition: var(--transition);
  }

  .genre-tag-premium:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--accent);
    color: var(--accent);
    transform: translateY(-2px);
  }

  .hero-overview-premium {
    color: var(--text-secondary);
    line-height: 1.8;
    font-size: 1.1rem;
    margin-bottom: 32px;
    max-width: 700px;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
  }

  .hero-actions-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .btn-watchlist-premium svg {
    transition: var(--transition);
  }

  .btn-watchlist-premium:hover svg {
    transform: scale(1.1);
  }

  /* Hero fallback for no trailer */
  .hero-poster-fallback {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .hero-poster-fallback img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center 20%;
  }

  .hero-gradient-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.3) 0%,
      rgba(0, 0, 0, 0.6) 60%,
      rgba(0, 0, 0, 0.95) 100%
    );
  }

  /* Content Section */
  .movie-detail-content {
    padding: 60px 4vw;
    max-width: 1400px;
    margin: 0 auto;
  }

  .content-section {
    margin-bottom: 80px;
  }

  .content-section h2 {
    margin-bottom: 32px;
    font-size: 2rem;
  }

  /* Cast Grid */
  .cast-grid-premium {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 28px;
  }

  .cast-card-premium {
    text-align: center;
  }

  .cast-photo-premium {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }

  .cast-photo-placeholder {
    width: 100%;
    aspect-ratio: 2/3;
    background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin-bottom: 12px;
  }

  .cast-name-premium {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 4px;
  }

  .cast-character-premium {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  /* Reviews */
  .review-form-card-premium,
  .auth-prompt-card-premium {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 36px;
    margin-bottom: 40px;
    backdrop-filter: blur(40px);
  }

  .auth-prompt-card-premium {
    text-align: center;
    padding: 56px;
  }

  .review-form-card-premium h3 {
    margin-bottom: 28px;
    font-size: 1.5rem;
  }

  .form-group {
    margin-bottom: 28px;
  }

  .form-group label {
    display: block;
    margin-bottom: 12px;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .star-rating-input-premium {
    display: flex;
    flex-direction: row-reverse;
    gap: 10px;
    justify-content: flex-end;
  }

  .star-rating-input-premium input[type="radio"] {
    display: none;
  }

  .star-label-premium {
    font-size: 2.8rem;
    cursor: pointer;
    transition: var(--transition);
    opacity: 0.3;
  }

  .star-label-premium:hover,
  .star-rating-input-premium input[type="radio"]:checked + .star-label-premium,
  .star-rating-input-premium input[type="radio"]:checked ~ .star-label-premium {
    opacity: 1;
    transform: scale(1.15);
  }

  .form-actions {
    display: flex;
    gap: 12px;
  }

  .btn-danger-premium {
    background: rgba(255, 69, 58, 0.2);
    border: 1px solid var(--error);
    color: var(--error);
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }

  .btn-danger-premium:hover {
    background: rgba(255, 69, 58, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 69, 58, 0.4);
  }

  .reviews-list-premium {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .review-card-premium {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 28px;
    backdrop-filter: blur(40px);
    transition: var(--transition);
  }

  .review-card-premium:hover {
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateX(4px);
  }

  .review-header-premium {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
  }

  .reviewer-name-premium {
    font-size: 1.15rem;
    font-weight: 600;
  }

  .review-date-premium {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .edited-tag {
    font-style: italic;
  }

  .review-stars-premium {
    color: #fbbf24;
    font-size: 1.3rem;
  }

  .review-text-premium {
    color: var(--text-primary);
    line-height: 1.8;
    font-size: 1.05rem;
  }

  .no-reviews-msg {
    text-align: center;
    color: var(--text-muted);
    padding: 60px 20px;
    font-size: 1.1rem;
  }

  /* Fade animations for metadata */
  @keyframes fadeOut {
    from {
      opacity: 1;
      visibility: visible;
    }
    to {
      opacity: 0;
      visibility: hidden;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      visibility: hidden;
    }
    to {
      opacity: 1;
      visibility: visible;
    }
  }

  #heroDetails.fade-out {
    animation: fadeOut 0.5s ease-out forwards;
  }

  #heroDetails.fade-in {
    animation: fadeIn 0.5s ease-in forwards;
  }

  .scroll-indicator.fade-out {
    animation: fadeOut 0.5s ease-out forwards;
  }

  .scroll-indicator.fade-in {
    animation: fadeIn 0.5s ease-in forwards;
  }

  @media (max-width: 768px) {
    .hero-info-overlay-netflix {
      padding: 40px 20px;
    }

    .hero-title-premium {
      font-size: 2.2rem;
    }

    .hero-logo-premium {
      max-width: min(320px, 85%);
      max-height: 100px;
    }

    .mute-btn-premium {
      width: 48px;
      height: 48px;
      bottom: 24px;
      right: 24px;
    }

    .cast-grid-premium {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 20px;
    }
  }
</style>

{% if movie.trailer_key %}
<script src="https://www.youtube.com/iframe_api"></script>
<script>
  let player;
  let isMuted = true;
  let fadeOutTimer;
  let mouseActivityTimer;
  let windowFocused = true;
  let hasScrolled = false;
  let isMetadataVisible = true;

  const FADE_DELAY = 5000; // 5 seconds
  const POSTER_DELAY = 2000; // 2 seconds

  function onYouTubeIframeAPIReady() {
    player = new YT.Player("trailerPlayer", {
      videoId: "{{ movie.trailer_key }}",
      playerVars: {
        autoplay: 0,
        controls: 0,
        modestbranding: 1,
        rel: 0,
        showinfo: 0,
        mute: 1,
        loop: 1,
        playlist: "{{ movie.trailer_key }}",
        playsinline: 1,
        iv_load_policy: 3,
        disablekb: 1,
        fs: 0,
        quality: "highres",
      },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
        onError: onPlayerError,
      },
    });
  }

  function onPlayerError(event) {
    // Error codes: 150 (same as 1), 2, 5, 100, 101, 150
    console.log("YouTube Player Error:", event.data);
    // Show poster permanently if video unavailable
    const posterOverlay = document.getElementById("posterOverlay");
    const trailerContainer = document.getElementById("trailerContainer");
    if (posterOverlay) {
      posterOverlay.classList.remove("is-hidden");
    }
    // Hide the player
    if (trailerContainer) {
      trailerContainer.style.opacity = "0.3";
    }
  }

  function onPlayerReady(event) {
    const posterOverlay = document.getElementById("posterOverlay");
    // Show metadata and scroll indicator for 5 seconds on page load
    showMetadata();
    scheduleMetadataFadeOut();

    if (posterOverlay) {
      setTimeout(() => {
        posterOverlay.classList.add("is-hidden");
        event.target.playVideo();
        event.target.setPlaybackQuality("highres");
      }, POSTER_DELAY);
      
      // Fallback: show poster after 8 seconds if video doesn't play
      setTimeout(() => {
        if (player && player.getPlayerState && (player.getPlayerState() === YT.PlayerState.UNSTARTED || player.getPlayerState() === YT.PlayerState.BUFFERING)) {
          console.log("Video not playing, showing poster");
          posterOverlay.classList.remove("is-hidden");
        }
      }, 8000);
    } else {
      event.target.playVideo();
      event.target.setPlaybackQuality("highres");
    }
  }

  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
      player.setPlaybackQuality("highres");
    }
  }

  // Show both metadata and scroll indicator
  function showMetadata() {
    // Don't repeatedly add fade-in if already visible
    if (isMetadataVisible) {
      return;
    }
    
    isMetadataVisible = true;
    const heroDetails = document.getElementById("heroDetails");
    const scrollIndicator = document.querySelector(".scroll-indicator");

    if (heroDetails) {
      heroDetails.classList.remove("fade-out");
      heroDetails.classList.add("fade-in");
    }
    // Only show scroll indicator if user hasn't scrolled yet
    if (scrollIndicator && !hasScrolled) {
      scrollIndicator.classList.remove("fade-out");
      scrollIndicator.classList.add("fade-in");
    }
  }

  // Fade out both metadata and scroll indicator
  function fadeOutUI() {
    // Don't repeatedly remove fade-in if already fading out
    if (!isMetadataVisible) {
      return;
    }
    
    isMetadataVisible = false;
    const heroDetails = document.getElementById("heroDetails");
    const scrollIndicator = document.querySelector(".scroll-indicator");

    if (heroDetails) {
      heroDetails.classList.remove("fade-in");
      heroDetails.classList.add("fade-out");
    }
    if (scrollIndicator) {
      scrollIndicator.classList.remove("fade-in");
      scrollIndicator.classList.add("fade-out");
    }
  }

  // Schedule fade out after 5 seconds
  function scheduleMetadataFadeOut() {
    if (fadeOutTimer) {
      clearTimeout(fadeOutTimer);
    }

    fadeOutTimer = setTimeout(() => {
      // Only fade out if window is focused
      if (windowFocused && isMetadataVisible) {
        fadeOutUI();
      }
    }, FADE_DELAY);
  }

  // Track mouse movement
  document.addEventListener("mousemove", () => {
    // Only show if not already visible to reduce flicker
    if (!isMetadataVisible) {
      showMetadata();
    }

    // Clear existing timers
    if (mouseActivityTimer) {
      clearTimeout(mouseActivityTimer);
    }
    if (fadeOutTimer) {
      clearTimeout(fadeOutTimer);
    }

    // Schedule new fade out after 5 seconds of no movement
    scheduleMetadataFadeOut();
  });

  // Track window focus
  window.addEventListener("focus", () => {
    windowFocused = true;
    if (!isMetadataVisible) {
      showMetadata();
    }
    scheduleMetadataFadeOut();
  });

  window.addEventListener("blur", () => {
    windowFocused = false;
    fadeOutUI();
    if (fadeOutTimer) {
      clearTimeout(fadeOutTimer);
    }
  });

  // Mute/Unmute toggle function
  function toggleMute() {
    if (player) {
      if (isMuted) {
        player.unMute();
        document.getElementById("muteIcon").innerHTML = `
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        `;
      } else {
        player.mute();
        document.getElementById("muteIcon").innerHTML = `
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <line x1="23" y1="9" x2="17" y2="15"></line>
          <line x1="17" y1="9" x2="23" y2="15"></line>
        `;
      }
      isMuted = !isMuted;
    }
  }

  // Mute/Unmute toggle on button click
  document.getElementById("muteBtn")?.addEventListener("click", toggleMute);

  // Mute/Unmute toggle on 'M' key press
  document.addEventListener("keydown", (event) => {
    if (event.key.toLowerCase() === "m") {
      toggleMute();
    }
  });

  // Toggle watchlist without page reload
  function toggleWatchlist(movieId, mediaType = "movie") {
    const btn = document.getElementById("watchlistBtn");
    const icon = document.getElementById("watchlistIcon");
    const text = document.getElementById("watchlistText");

    // Disable button during request
    btn.disabled = true;

    fetch(`/movies/${movieId}/watchlist`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ media_type: mediaType }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const inWatchlist = data.in_watchlist;
          // Update button state
          if (inWatchlist) {
            icon.setAttribute("fill", "currentColor");
            text.textContent = "In Watchlist";
          } else {
            icon.setAttribute("fill", "none");
            text.textContent = "Add to Watchlist";
          }
        }
      })
      .catch((error) => console.error("Error:", error))
      .finally(() => {
        btn.disabled = false;
      });
  }

  // Track scroll and permanently fade out scroll indicator when user scrolls down
  window.addEventListener("scroll", () => {
    if (window.pageYOffset > 100) {
      if (!hasScrolled) {
        hasScrolled = true;
        const scrollIndicator = document.querySelector(".scroll-indicator");
        if (scrollIndicator) {
          scrollIndicator.classList.remove("fade-in");
          scrollIndicator.classList.add("fade-out");
        }
      }
    }
  });
</script>
{% endif %} {% endblock %}
